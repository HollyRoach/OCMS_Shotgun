"""===========================
pipeline_classifyreads.py
===========================

Overview
========

This pipeline takes raw fastq files and taxonomically classifies them. It also estimates abundance.
files :file:``pipeline.yml` and :file:`conf.py`.

Usage
=====

See :ref:`PipelineSettingUp` and :ref:`PipelineRunning` on general
information how to use cgat pipelines.

Configuration
-------------

The pipeline requires a configured :file:`pipeline.yml` file.

Default configuration files can be generated by executing:

   python <srcdir>/pipeline_classifyreads.py config

Input files
-----------

fastq files that are in the format .fastq.1.gz and .fastq.2.gz.

Requirements
------------


Requirements:


Pipeline output
===============


Glossary
========

.. glossary::


Code
====

"""
import sys
import os
from ruffus import *
from cgatcore import pipeline as P

# load options from the config file
PARAMS = P.get_parameters(
    ["pipeline.yml"])

#get all files within the directory to process
SEQUENCEFILES = ("*.fastq.1.gz")

SEQUENCEFILES_REGEX = regex(
    r"(\S+).(fastq.1.gz)")


########################################################
########################################################
########################################################
# Run kraken2 on raw reads
########################################################
########################################################
########################################################

@follows(mkdir("kraken2.dir"))
@transform(SEQUENCEFILES, SEQUENCEFILES_REGEX, r"kraken2.dir/\1.abundance.tsv.gz")
def classifyReadsWithKraken2(infile, outfile):
    '''classify reads with kraken2
    '''
    # Note that at the moment I only deal with paired-end
    # reads
    p1 = infile
    p2 = p1.replace(".fastq.1.gz", ".fastq.2.gz")

    prefix = P.snip(outfile, ".abundance.tsv.gz")
    
    db = PARAMS.get("kraken2_db")
    nthreads = PARAMS.get("kraken2_nthreads")
    job_mem = PARAMS.get("kraken2_job_mem" + "G")
    options = PARAMS.get("kraken2_options")
    statement = '''kraken2
                   --db %(db)s
                   --use-mpa-style
                   --output %(prefix)s.classified.tsv
                   --paired
                   --report %(prefix)s.abundance.tsv
                   --use-names
                   --threads %(nthreads)s
                   --gzip-compressed %(p1)s %(p2)s
                   %(options)s;
                   gzip %(prefix)s.classified.tsv %(prefix)s.abundance.tsv
                '''
    P.run(statement)

########################################################
########################################################
########################################################
# Parse kraken output
########################################################
########################################################
########################################################

@follows(mkdir("taxonomy_abundances.dir"))
@split(classifyReadsWithKraken2, "taxonomy_abundances.dir/*.tsv.gz")
def buildTaxonomyAbundances(infile, outfiles):
    pass


# ---------------------------------------------------
# Generic pipeline tasks
@follows(buildTaxonomyAbundances)
def full():
    pass


def main(argv=None):
    if argv is None:
        argv = sys.argv
    P.main(argv)


if __name__ == "__main__":
    sys.exit(P.main(sys.argv))    
